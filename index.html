<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Content-Security-Policy" content="style-src 'unsafe-inline' github.githubassets.com https://www.gstatic.com;">
<title>QRコードリーダー（削除機能付き）</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f0f4f8;
    color: #333;
    margin: 0; padding: 1rem; text-align: center;
    overflow-x: hidden;
  }
  h1 { font-size: 1.8rem; margin-bottom: 0.5rem; }
  #currentSeatDisplay {
    margin: 1rem auto;
    font-size: 1.3rem;
    font-weight: bold;
    max-width: 480px;
    padding: 0.8rem 1rem;
    border-radius: 8px;
    background-color: #ffe082; /* 明るいオレンジ */
    color: #5d4037;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  #result {
    font-weight: bold;
    background-color: #e0f7fa;
    padding: 0.8rem 1rem;
    margin: 0 auto 1.5rem;
    max-width: 480px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    white-space: pre-wrap;
    word-break: break-word;
    min-height: 3rem;
  }
  .button-group {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
    max-width: 320px;
    margin: 1rem auto 3rem;
  }
  button {
    background-color: #4caf50;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.8rem 1rem;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.1s ease;
  }
  button:hover { background-color: #43a047; }
  button:active { transform: scale(0.97); }
  #completeSeatBtn {
    background-color: #ff9800;
    display: none;
  }
  #completeSeatBtn:hover { background-color: #fb8c00; }
  table {
    width: 95%;
    max-width: 800px;
    margin: 0 auto;
    border-collapse: collapse;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    overflow: hidden;
  }
  th {
    background-color: #4caf50;
    color: white;
    padding: 10px;
    text-align: left;
  }
  td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    vertical-align: middle;
  }
  tbody tr:last-child td {
    border-bottom: none;
  }
  .student {
    display: inline-block;
    background-color: #e3f2fd;
    color: #1976d2;
    padding: 4px 8px;
    border-radius: 16px;
    margin: 4px 6px 4px 0;
    font-size: 0.9rem;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s ease;
  }
  .student:hover {
    background-color: #bbdefb;
  }
  .seat {
    cursor: pointer;
    color: #d32f2f;
    font-weight: bold;
    user-select: none;
    transition: color 0.3s ease;
  }
  .seat:hover {
    color: #b71c1c;
    text-decoration: underline;
  }
  #seatTable tbody tr:hover {
    background-color: #e8f5e9;
  }
  #ranking-select-ui {
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    padding: 1rem;
    background: #fff;
    border: 1px solid #ccc;
    max-width: 500px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  #sortable-player-list {
    list-style: none;
    padding: 0;
    max-height: 300px;
    overflow-y: auto;
    margin-top: 1rem;
  }
  #sortable-player-list li {
    padding: 8px;
    margin: 4px 0;
    background: #e3f2fd;
    border-radius: 4px;
    cursor: move;
    user-select: none;
  }
  #sortable-player-list li.dragging {
    opacity: 0.5;
  }
</style>
</head>
<body>

<h1>QRコードリーダー</h1>
<p>座席（table〜）→ 生徒（player〜）の順に読み取り。6人まで登録。生徒IDをクリックで削除。</p>

<!-- currentSeat 状態表示 -->
<div id="currentSeatDisplay" aria-live="polite" role="region" aria-label="現在の座席選択状況">
  現在の座席: <span id="currentSeatText">未選択</span>
</div>

<div id="reader-wrapper"><div id="reader"></div></div>

<div id="result" aria-live="polite" role="status">ここに読み取り結果が表示されます</div>

<div class="button-group" role="group" aria-label="操作ボタン群">
  <button onclick="downloadCSV()" aria-label="CSVで保存">CSVで保存</button>
  <button id="completeSeatBtn" onclick="completeCurrentSeat()" aria-label="現在の座席登録完了ボタン">この座席の登録を完了</button>
  <button onclick="undoLast()" aria-label="最後の追加を取り消す">最後の追加を取り消す</button>
  <button onclick="clearSavedData()" aria-label="保存データを削除">🗑 保存データを削除</button>
  <button onclick="saveSeatMapToDrive()" aria-label="Google Driveに保存">💾 Google Driveに保存</button>
  <button onclick="loadSeatMapFromDrive()" aria-label="Driveから復元">☁ Driveから復元</button>
  <button onclick="toggleRankingMode()" aria-pressed="false" id="toggleRankingBtn">📋 順位登録モード切替</button>
</div>

<section class="footer-area" aria-label="現在の座席登録状況">
  <h2>現在の座席登録</h2>
  <table id="seatTable" role="table" aria-describedby="tableDesc">
    <caption id="tableDesc">座席IDと生徒ID一覧</caption>
    <thead>
      <tr><th scope="col">座席ID</th><th scope="col">生徒ID一覧</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbyTxi9AHEaql2PpbrlnpFIW0jVzqD2jo_MEftHHYGQCSXPm5Dcqlz4UcZ_nQYHNDHdT/exec";

  let currentSeat = null;
  let seatMap = {};
  let actionHistory = [];
  let lastScanTime = 0;
  let isRankingMode = false;

  let players = JSON.parse(localStorage.getItem("players") || "{}");

  document.addEventListener("DOMContentLoaded", async () => {
    const savedMap = localStorage.getItem("seatMap");
    if (savedMap) {
      seatMap = JSON.parse(savedMap);
      displayMessage("📦 前回のデータを復元しました");
      updateTable();
    } else {
      await loadSeatMapFromDrive();
    }
    startQrCodeScanner();
    updateCompleteSeatBtn(false);
    updateRankingToggleButton();
    updateCurrentSeatDisplay();
  });

  function startQrCodeScanner() {
    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      {
        fps: 15,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.33
      },
      onScanSuccess,
      onScanFailure
    ).catch(err => {
      console.error("カメラ起動エラー:", err);
      displayMessage("カメラ起動に失敗しました: " + err);
    });
  }

  function onScanFailure(error) {
    // スキャン失敗は無視
  }

  function onScanSuccess(decodedText) {
    const now = Date.now();
    if (now - lastScanTime < 2000) return;
    lastScanTime = now;

    if (!/^(table|player)/.test(decodedText)) {
      displayMessage("❗不正なQRコードです。'table〜' または 'player〜' で始めてください。");
      return;
    }

    if (isRankingMode) {
      if (decodedText.startsWith("table")) {
        if (!seatMap[decodedText]) {
          displayMessage(`⚠ 座席データが存在しません: ${decodedText}`);
          return;
        }
        showRankingSelection(decodedText);
      } else {
        displayMessage("⚠ 順位登録モードでは座席QRのみ読み取ってください。");
      }
      return;
    }

    if (decodedText.startsWith("table")) {
      currentSeat = decodedText;
      if (!seatMap[currentSeat]) seatMap[currentSeat] = [];
      displayMessage(`座席「${currentSeat}」を読み取りました。最大6人まで登録可能。`);
      updateCompleteSeatBtn(true);
      updateTable();
      updateCurrentSeatDisplay();
      return;
    }

    if (decodedText.startsWith("player")) {
      if (!currentSeat) {
        displayMessage("最初に座席QR（table〜）を読み取ってください。");
        return;
      }
      const people = seatMap[currentSeat];
      if (people.length >= 6) {
        displayMessage(`座席「${currentSeat}」は6人までです。登録を完了します。`);
        completeCurrentSeat();
        updateCurrentSeatDisplay();
        return;
      }
      if (people.includes(decodedText)) {
        displayMessage(`「${decodedText}」は既に座席「${currentSeat}」に登録されています。`);
        return;
      }
      people.push(decodedText);
      actionHistory.push({ seat: currentSeat, person: decodedText });
      displayMessage(`「${decodedText}」を座席「${currentSeat}」に登録（${people.length}/6）`);
      if (people.length >= 6) {
        displayMessage("上限に達しました。登録を完了します。");
        completeCurrentSeat();
      }
      updateTable();
      updateCurrentSeatDisplay();
    }
  }

  function displayMessage(msg) {
    const el = document.getElementById("result");
    if (el) el.innerText = msg;
  }

  function updateCompleteSeatBtn(show) {
    const btn = document.getElementById("completeSeatBtn");
    if (!btn) return;
    btn.style.display = show ? "inline-block" : "none";
  }

  function updateRankingToggleButton() {
    const btn = document.getElementById("toggleRankingBtn");
    if (!btn) return;
    btn.setAttribute("aria-pressed", isRankingMode.toString());
    btn.textContent = isRankingMode ? "📋 順位登録モードを終了" : "📋 順位登録モード切替";
  }

  // ここを強化：現在の座席表示更新
  function updateCurrentSeatDisplay() {
    const el = document.getElementById("currentSeatText");
    if (!el) return;

    if (!currentSeat) {
      el.textContent = "未選択";
      el.style.color = "#666";
      el.style.fontWeight = "normal";
    } else {
      const peopleCount = seatMap[currentSeat]?.length || 0;
      el.textContent = `${currentSeat} （登録済み ${peopleCount} / 6 人）`;
      el.style.color = "#5d4037";
      el.style.fontWeight = "bold";
    }
  }

  function updateTable() {
    const tbody = document.querySelector('#seatTable tbody');
    tbody.innerHTML = '';
    for (const [seat, people] of Object.entries(seatMap)) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${seat} <button class="seat" aria-label="座席${seat}を削除" onclick="removeSeat('${seat}')">❌</button></td>
        <td>${people.map(p =>
          `<button class="student" aria-label="生徒${p}を削除" onclick="removeStudent('${seat}', '${p}')">${p} ❌</button>`
        ).join(' ')}</td>
      `;
      tbody.appendChild(row);
    }
    localStorage.setItem("seatMap", JSON.stringify(seatMap));
  }

  function removeStudent(seat, person) {
    const people = seatMap[seat];
    if (!people) return;
    const index = people.indexOf(person);
    if (index !== -1) {
      people.splice(index, 1);
      displayMessage(`座席「${seat}」から「${person}」を削除しました。`);
      updateTable();
      if (seat === currentSeat) updateCurrentSeatDisplay();
    }
  }

  function removeSeat(seat) {
    if (confirm(`座席「${seat}」を削除しますか？（生徒もすべて削除されます）`)) {
      delete seatMap[seat];
      displayMessage(`座席「${seat}」を削除しました。`);
      if (currentSeat === seat) {
        currentSeat = null;
        updateCompleteSeatBtn(false);
        updateCurrentSeatDisplay();
      }
      updateTable();
    }
  }

  function completeCurrentSeat() {
    if (currentSeat) {
      displayMessage(`座席「${currentSeat}」の登録を完了しました。`);
      currentSeat = null;
      updateCompleteSeatBtn(false);
      updateCurrentSeatDisplay();
    }
  }

  function undoLast() {
    if (actionHistory.length === 0) {
      displayMessage("これ以上取り消せる操作はありません。");
      return;
    }
    const { seat, person } = actionHistory.pop();
    const people = seatMap[seat];
    if (people) {
      const index = people.lastIndexOf(person);
      if (index !== -1) {
        people.splice(index, 1);
        displayMessage(`「${person}」の登録を取り消しました。`);
        updateTable();
        if (seat === currentSeat) updateCurrentSeatDisplay();
      }
    }
  }

  function clearSavedData() {
    if (confirm("保存データをすべて削除しますか？")) {
      localStorage.removeItem("seatMap");
      localStorage.removeItem("players");
      seatMap = {};
      players = {};
      currentSeat = null;
      displayMessage("保存されたデータを削除しました。");
      updateTable();
      updateCurrentSeatDisplay();
      updateCompleteSeatBtn(false);
    }
  }

  function downloadCSV() {
    let csv = "座席ID,生徒ID\n";
    for (const [seat, people] of Object.entries(seatMap)) {
      people.forEach(person => {
        csv += `${seat},${person}\n`;
      });
    }
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "seat_assignment.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  function saveSeatMapToDrive() {
    fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify(seatMap)
    })
    .then(res => res.text())
    .then(text => {
      if (text.includes("saved")) {
        displayMessage("✅ Google Driveに保存しました！");
      } else {
        displayMessage("❌ 保存に失敗しました: " + text);
      }
    })
    .catch(err => {
      console.error("保存エラー:", err);
      displayMessage("❌ 保存エラーが発生しました");
    });
  }

  async function loadSeatMapFromDrive() {
    try {
      const res = await fetch(API_URL);
      if (!res.ok) throw new Error("読み込み失敗");
      const json = await res.json();
      seatMap = json;
      updateTable();
      displayMessage("☁ Google Driveから復元しました");
      localStorage.setItem("seatMap", JSON.stringify(seatMap));
      updateCurrentSeatDisplay();
    } catch (e) {
      displayMessage("❌ Driveからの復元に失敗しました");
      console.error(e);
    }
  }

  function toggleRankingMode() {
    isRankingMode = !isRankingMode;
    displayMessage(isRankingMode
      ? "✅ 順位登録モードに入りました（座席QRを読み取ってください）"
      : "📦 通常モードに戻りました");
    updateCompleteSeatBtn(false);
    updateRankingToggleButton();
  }

  function showRankingSelection(seatID) {
    const playersInSeat = seatMap[seatID];
    if (!playersInSeat || playersInSeat.length === 0) {
      displayMessage(`座席 ${seatID} にプレイヤーが登録されていません`);
      return;
    }

    const existing = document.getElementById('ranking-select-ui');
    if (existing) existing.remove();

    const container = document.createElement('div');
    container.id = 'ranking-select-ui';
    container.setAttribute("role", "dialog");
    container.setAttribute("aria-modal", "true");

    const title = document.createElement('h3');
    title.textContent = `座席 ${seatID} の順位を決めてください（ドラッグで並べ替え）`;
    container.appendChild(title);

    const list = document.createElement('ul');
    list.id = 'sortable-player-list';

    playersInSeat.forEach(player => {
      const li = document.createElement('li');
      li.textContent = player;
      li.setAttribute('tabindex', '0'); // ← これを追加
      li.className = 'draggable-item';
      list.appendChild(li);
    });

    container.appendChild(list);

    const btnSave = document.createElement('button');
    btnSave.textContent = "順位を保存";
    btnSave.onclick = () => {
      saveRanking(seatID, [...list.children].map(li => li.textContent));
      container.remove();
      isRankingMode = false;
      updateRankingToggleButton();
    };
    container.appendChild(btnSave);

    const btnCancel = document.createElement('button');
    btnCancel.textContent = "キャンセル";
    btnCancel.style.marginLeft = "10px";
    btnCancel.onclick = () => {
      container.remove();
      displayMessage("順位登録をキャンセルしました");
    };
    container.appendChild(btnCancel);

    document.body.appendChild(container);

    let dragged = null;
    list.addEventListener('dragstart', (e) => {
      dragged = e.target;
      e.target.classList.add('dragging');
    });
    list.addEventListener('dragend', (e) => {
      e.target.classList.remove('dragging');
      dragged = null;
    });
    list.addEventListener('dragover', (e) => {
      e.preventDefault();
      const afterElement = getDragAfterElement(list, e.clientY);
      if (afterElement == null) {
        list.appendChild(dragged);
      } else {
        list.insertBefore(dragged, afterElement);
      }
    });

    // 🆕 スマホタッチ操作を追加
list.addEventListener('touchstart', (e) => {
  dragged = e.target.closest('.draggable-item');
  dragged.classList.add('dragging');
  e.preventDefault();
});
list.addEventListener('touchmove', (e) => {
  const touch = e.touches[0];
  const afterElement = getDragAfterElement(list, touch.clientY);
  if (afterElement && dragged !== afterElement) {
    list.insertBefore(dragged, afterElement);
  }
  e.preventDefault();
});
list.addEventListener('touchend', (e) => {
  if (dragged) dragged.classList.remove('dragging');
  dragged = null;
});

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.draggable-item:not(.dragging)')];
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
  }

  function saveRanking(seatID, rankedPlayers) {
    displayMessage(`座席${seatID}の順位を保存しました: ${rankedPlayers.join(", ")}`);
    // 実際の順位反映はここに実装してください
  }
</script>

</body>
</html>
